<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.campick.dao.IPartnerApprovalDAO">
	
	<!-- 미처리된 승인 & 승인완료 내역 뽑기 -->
	<select id="partnerApprovalList" resultType="com.campick.dto.PartnerApprovalDTO">
		SELECT APPROVALNUM, PARTNERID, PARTNERNAME, PHONE AS PARTNERPHONE, BUSINESSLICENSE, APPROVALDATE
		, NVL(APPROVALSTATUSNUM, 0) AS APPROVALSTATUSNUM
		, NVL(APPROVALSTATUSNAME, '승인대기') AS APPROVALSTATUSNAME
		, NVL(LICENSE_FILEROUTE,'없음') AS FILEROUTE
		, NVL(LICENSE_FILENAME,'없음') AS FILENAME
		FROM PARTNER_APPROVAL_VIEW
		WHERE(PARTNERID, APPROVALNUM) IN
		(
		    SELECT PARTNERID, MAX(APPROVALNUM) AS APPROVALNUM
		    FROM PARTNER_APPROVAL_VIEW
		    GROUP BY PARTNERID
		)
		ORDER BY APPROVALNUM DESC
	</select>
	
	
	<!-- 승인 반려 내역 뽑기 -->
	<select id="partnerNotApprovedList" resultType="com.campick.dto.PartnerApprovalDTO">
		SELECT APPROVALNUM, PARTNERID, PARTNERNAME, PHONE AS PARTNERPHONE, BUSINESSLICENSE, APPROVALDATE
		, NVL(APPROVALSTATUSNUM, 0) AS APPROVALSTATUSNUM
		, NVL(APPROVALSTATUSNAME, '승인대기') AS APPROVALSTATUSNAME
		, NVL(LICENSE_FILEROUTE,'없음') AS FILEROUTE
		, NVL(LICENSE_FILENAME,'없음') AS FILENAME
		FROM PARTNER_APPROVAL_VIEW
		WHERE APPROVALSTATUSNUM = 2
		ORDER BY APPROVALNUM DESC
	</select>
	
	<select id="getPartnerApprovalCount" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM
		(
		    SELECT APPROVALNUM, PARTNERID, PARTNERNAME, PHONE, APPROVALDATE
		    , NVL(APPROVALSTATUSNUM, 0) AS APPROVALSTATUSNUM
		    , NVL(APPROVALSTATUSNAME, '승인대기') AS APPROVALSTATUSNAME
		    , NVL(LICENSE_FILEROUTE,'없음') AS LICENSE_FILEROUTE
		    , NVL(LICENSE_FILENAME,'없음') AS LICENSE_FILENAME
		    FROM PARTNER_APPROVAL_VIEW
		    WHERE(PARTNERID, APPROVALNUM) IN
		    (
		        SELECT PARTNERID, MAX(APPROVALNUM) AS APPROVALNUM
		        FROM PARTNER_APPROVAL_VIEW
		        GROUP BY PARTNERID
		    )
		    ORDER BY APPROVALNUM DESC
		)
		WHERE APPROVALSTATUSNAME = '승인대기'
	</select>
	
	<select id="getPartnerApprovedCount" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM
		(
		    SELECT APPROVALNUM, PARTNERID, PARTNERNAME, PHONE, APPROVALDATE
		    , NVL(APPROVALSTATUSNUM, 0) AS APPROVALSTATUSNUM
		    , NVL(APPROVALSTATUSNAME, '승인대기') AS APPROVALSTATUSNAME
		    , NVL(LICENSE_FILEROUTE,'없음') AS LICENSE_FILEROUTE
		    , NVL(LICENSE_FILENAME,'없음') AS LICENSE_FILENAME
		    FROM PARTNER_APPROVAL_VIEW
		    WHERE(PARTNERID, APPROVALNUM) IN
		    (
		        SELECT PARTNERID, MAX(APPROVALNUM) AS APPROVALNUM
		        FROM PARTNER_APPROVAL_VIEW
		        GROUP BY PARTNERID
		    )
		    ORDER BY APPROVALNUM DESC
		)
		WHERE APPROVALSTATUSNAME = '승인완료'
	</select>
	
	<select id="getPartnerNotApprovedCount" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM
		(
		    SELECT APPROVALNUM, PARTNERID, PARTNERNAME, PHONE, APPROVALDATE
		    , NVL(APPROVALSTATUSNUM, 0) AS APPROVALSTATUSNUM
		    , NVL(APPROVALSTATUSNAME, '승인대기') AS APPROVALSTATUSNAME
		    , NVL(LICENSE_FILEROUTE,'없음') AS LICENSE_FILEROUTE
		    , NVL(LICENSE_FILENAME,'없음') AS LICENSE_FILENAME
		    FROM PARTNER_APPROVAL_VIEW
		    ORDER BY APPROVALNUM DESC
		)
		WHERE APPROVALSTATUSNAME = '승인반려'
	</select>
	
	
	<insert id="PartnerApprovalInsert">
		INSERT INTO APPROVAL_HISTORY (APPROVALNUM, PARTNERID, APPROVALSTATUSNUM, APPROVALDATE, MEMBERNUM)
		VALUES(PARTNER_APP_SEQ.NEXTVAL, #{pi}, ${approvalnum}, SYSDATE, 1)
	</insert>
</mapper>